<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="./pp-day.html">
<link rel="import" href="./pp-date-util.html">
<link rel="import" href="./pp-date-selecter.html">

<!--
    `calendar-month`

    @demo demo/calendar-month.html 
-->

<dom-module id="pp-month">
    <template>
        <style>
            :host {
                display: flex;
                flex-direction: column;
                height: 14em;
            }

            .week {
                display: flex;
                flex-direction: row;
                width: 100%;
                height: 100%;
            }
        </style>
        <!-- begin: data -->
        <pp-date-util id="date-util"></pp-date-util>
        <pp-date-selecter id="date-selecter"
                          dates="{{dates}}"
                          last-selected="{{date}}"
                          max="[[_maxSelected(range)]]"
        ></pp-date-selecter>
        <!-- end: data -->

        <!-- begin: ui -->
        <template is="dom-repeat" 
                  items="[[weeks]]"
                  as="week">
            <div class="week">
                <template is="dom-repeat"
                          items="[[week]]"
                          as="day"
                >
                    <pp-day date="[[day]]"
                            selected$="[[_isSelected(range, day, dates.*)]]"
                            within-range$="[[_isWithinRange(range, day, dates.*)]]"
                            disabled$="[[_isOutsideMinMax(day, minDate, maxDate)]]"
                            on-tap="_daySelected"
                            outside$="[[_isOutsideMonth(day, month)]]"
                            is-min$="[[_isSameDate(day, minDate)]]"
                            is-max$="[[_isSameDate(day, maxDate)]]"
                            class$="day"
                    ></pp-day>
                </template>
            </div>
        </template>
        <!-- end: ui -->
    </template>

    <script>
        Polymer({
            is: 'pp-month',
            properties: {
                date: {
                    type: Object,
                    notify: true,
                    value: () => new Date()
                },
                dates: {
                    type: Array,
                    notify: true,
                    value: () => [new Date()]
                },
                year: {
                    type: Number,
                    value: () => (new Date()).getFullYear()
                },
                month: {
                    type: Number,
                    value: () => (new Date()).getMonth()
                },
                weeks: {
                    type: Array,
                    notify: true,
                    computed: '_buildWeeks(year, month, locale.startOfWeek)'
                },
                locale: {
                    type: Object,
                    value: () => ({ startOfWeek: 1 })
                },
                minDate: {
                    type: Object,
                    value: null
                },
                maxDate: {
                    type: Object,
                    value: null
                },
                range: {
                    type: Boolean,
                    value: false
                }
            },

            _buildWeeks (year, month, startOfWeek) {
                const fromDate = this._getStartDate(year, month, startOfWeek);
                const weekOffsets = [0, 1, 2, 3, 4, 5];
                return weekOffsets
                    .map(weekOffset => this._buildWeek(fromDate, weekOffset));
            },

            _buildWeek (fromDate, weekOffset) {
                const year = fromDate.getFullYear();
                const month = fromDate.getMonth();
                const date = fromDate.getDate();

                const dayOffsets = [0, 1, 2, 3, 4, 5, 6];
                return dayOffsets.map(dayOffset => {
                    const offset = weekOffset * 7 + dayOffset;
                    return new Date(year, month, date + offset);
                });
            },

            _getDay (date, startOfWeek) {
                const offset = 7 - startOfWeek;
                return (date.getDay() + offset) % 7;
            },

            _getStartDate (year, month, startOfWeek) {
                const firstDate = new Date(year, month, 1);
                const day = this._getDay(firstDate, startOfWeek);
                return new Date(year, month, 1 - day);
            },

            _buildDates (fromDate) {
                const offsets = [0, 1, 2, 3, 4, 5, 6];
                const year = fromDate.getFullYear();
                const month = fromDate.getMonth();
                const date = fromDate.getDate();

                return offsets.map(offset => new Date(year, month, date + offset));
            },

            _isSameDate (target, ...sources) {
                const dateUtil = this.$['date-util'];
                const same = sources.find(src => dateUtil.isSame(target, src));
                return !!same;
            },

            _isOutsideMonth (date, month) {
                return date.getMonth() !== month;
            },

            _isInRange (date, minDate, maxDate) {
                const dateUtil = this.$['date-util'];
                return !dateUtil.isBefore(date, minDate) &&
                    !dateUtil.isAfter(date, maxDate);
            },

            _isOutsideMinMax(date, minDate, maxDate) {
                return !this._isInRange(date, minDate, maxDate);
            },

            _isWithinRange (range, date) {
                if (!range || this.dates.length < 2) {
                    return false;
                }
                return this._isInRange(date, this.dates[0], this.dates[1]);
            },

            _isSelected (range, date) {
                if (!this.dates.length) {
                    return false;
                }
                return this._isSameDate(date, ...this.dates);
            },

            _maxSelected (range) {
                return range ? 2 : 1;
            },

            _daySelected (event) {
                const normalizedEvent = Polymer.dom(event);
                const target = normalizedEvent.localTarget;

                if (target.disabled) {
                    return;
                }
                this.$['date-selecter'].select(target.date);
            }
        });
    </script>
</dom-module>
