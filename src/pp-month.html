<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-meta/iron-meta.html">
<link rel="import" href="./pp-day.html">

<!--
    `calendar-month`

    @demo demo/calendar-month.html 
-->

<dom-module id="pp-month">
    <template>
        <style>
            :host {
                display: flex;
                flex-direction: column;
                justify-content: space-around;
                height: 16em;
            }

            .week {
                display: flex;
                flex-direction: row;
                width: 100%;
                justify-content: space-around;
            }

            pp-day[outside] {
                opacity: 0.5;
            }
        </style>
        <iron-meta id="meta"></iron-meta>
        <template is="dom-repeat" 
                  items="[[weeks]]"
                  as="week">
            <div class="week">
                <template is="dom-repeat"
                          items="[[week]]"
                          as="date">
                    <pp-day date="[[date]]"
                            selected$="[[_isSameDate(date, activeDate)]]"
                            on-tap="_daySelected"
                            outside$="[[_isOutsideMonth(date, activeDate)]]"
                            class$="day">
                    </pp-day>
                </template>
            </div>
        </template>
    </template>

    <script>
        Polymer({
            is: 'pp-month',
            properties: {
                activeDate: {
                    type: Object,
                    notify: true,
                    value: () => new Date()
                },
                year: {
                    type: Number,
                    value: () => (new Date()).getFullYear()
                },
                month: {
                    type: Number,
                    value: () => (new Date()).getMonth()
                },
                weeks: {
                    type: Array,
                    notify: true,
                    computed: '_buildWeeks(year, month)'
                }
            },

            _buildWeeks (year, month) {
                const fromDate = this._getStartDate(year, month, this._startOfWeek);
                const weekOffsets = [0, 1, 2, 3, 4];
                return weekOffsets
                    .map(weekOffset => this._buildWeek(fromDate, weekOffset));
            },

            get _startOfWeek () {
                const defaultLocale = { startOfWeek: 1 };
                const locale = this.$.meta.byKey('locale');
                return (locale || defaultLocale).startOfWeek;
            },

            _buildWeek (fromDate, weekOffset) {
                const year = fromDate.getFullYear();
                const month = fromDate.getMonth();
                const date = fromDate.getDate();

                const dayOffsets = [0, 1, 2, 3, 4, 5, 6];
                return dayOffsets.map(dayOffset => {
                    const offset = weekOffset * 7 + dayOffset;
                    return new Date(year, month, date + offset);
                });
            },

            _getDay (date, startOfWeek) {
                const offset = 7 - startOfWeek;
                return (date.getDay() + offset) % 7;
            },

            _getStartDate (year, month, startOfWeek) {
                const firstDate = new Date(year, month, 1);
                const day = this._getDay(firstDate, startOfWeek);
                return new Date(year, month, 1 - day);
            },

            _buildDates (fromDate) {
                const offsets = [0, 1, 2, 3, 4, 5, 6];
                const year = fromDate.getFullYear();
                const month = fromDate.getMonth();
                const date = fromDate.getDate();

                return offsets.map(offset => new Date(year, month, date + offset));
            },

            _isSameDate (date, activeDate) {
                return date.getDate() === activeDate.getDate() &&
                    date.getMonth() === activeDate.getMonth() &&
                    date.getFullYear() === activeDate.getFullYear();
            },

            _isOutsideMonth (date, activeDate) {
                return date.getMonth() !== activeDate.getMonth();
            },

            _daySelected (event) {
                const normalizedEvent = Polymer.dom(event);
                const { date } = normalizedEvent.localTarget;
                this.set('activeDate', date);
            }
        });
    </script>
</dom-module>
