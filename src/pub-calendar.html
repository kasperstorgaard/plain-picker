<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="./pub-calendar-day.html">

<!--
    `calendar-month`
    a publish time input

    @demo demo/calendar-month.html 
-->

<dom-module id="pub-calendar">
    <template>
        <style>
            :host {
                display: block;
            }

            .table {
                border: 1px solid black;
            }
            
            .week {
                width: 100%;
                display: flex;
                justify-content: space-around;
                color: black;
            }

            .day {
                width: 100%;
                line-height: 3em;
                font-family: monospace;
            }
            
            .day.outside {
                color: rgba(55,55,55,0.6);
            }
        </style>
        <div id="table">
            <template is="dom-repeat" 
                      items="[[_weeks]]"
                      as="week">
                <div class="week">
                    <template is="dom-repeat"
                              items="[[week.dates]]"
                              as="date">
                        <pub-calendar-day date="[[date]]"
                                          active="[[_isActive(date, day, _jsMonth, year)]]"
                                          class$="day [[_getOutsideClass(date, _jsMonth)]]">
                        </pub-calendar-day>
                    </template>
                </div>
            </template>
        </div>
    </template>

    <script>
        Polymer({
            is: 'pub-calendar',
            properties: {
                day: {
                    type: Number,
                    value: () => (new Date()).getDate()
                },
                month: {
                    type: Number, // 1
                    value: () => (new Date()).getMonth() + 1
                },
                year: {
                    type: Number,
                    value: () => (new Date()).getFullYear()
                },
                startOfWeek: {
                    type: Number,
                    value: 1
                },
                _weeks: {
                    type: Array,
                    computed: '_buildWeeks(_startDate)'
                },
                _jsMonth: { // 0 based
                    type: Number,
                    computed: '_getJsMonth(month)'
                },
                _firstDateOfMonth: {
                    type: Object,
                    computed: '_getFirstDateOfMonth(_jsMonth, year)'
                },
                _lastDateOfMonth: {
                    type: Object,
                    computed: '_getLastDateOfMonth(_jsMonth, year)'
                },
                _startDate: {
                    type: Number,
                    computed: '_getStartDate(_firstDateOfMonth, _jsMonth, year, startOfWeek)'
                }
            },

            _isActive (date, day, month, year) {
                return date.getDate() === day && date.getMonth() === month &&
                    date.getFullYear() === year;
            },

            _buildWeeks (fromDate) {
                return [0, 7, 14, 21, 28].map(offset => this._buildWeek(fromDate, offset));
            },

            _buildWeek (fromDate, offset) {
                const base = (new Array(7)).fill();
                const year = fromDate.getFullYear();
                const month = fromDate.getMonth();
                const date = fromDate.getDate();

                const dates = base
                    .map((val, idx) => date + idx + offset)
                    .map(day => new Date(year, month, day));

                return { dates };
            },

            _getJsMonth (month) {
                return month - 1;
            },

            _getFirstDateOfMonth (month, year) {
                return new Date(year, month, 1);
            },

            _getLastDateOfMonth (month, year) {
                const endNumber = this._getMonthLength(month, year);
                return new Date(year, month, endNumber);
            },

            _getMonthLength (month, year) {
                // check leap year
                if (month === 2) {
                    const isLeapYear = (new Date(year, 1, 29)).getMonth() === 1;
                    return isLeapYear ? 29 : 28;
                }
                const lengths = [31, null, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                return lengths[month];
            },

            _getDay (date, startOfWeek) {
                const offset = 7 - startOfWeek;
                return (date.getDay() + offset) % 7;
            },

            _getStartDate (firstDateOfMonth, month, year, startOfWeek) {
                const day = this._getDay(firstDateOfMonth, startOfWeek);
                const offset = day === 0 ? 7 : day - 1;
                const lastMonth = month === 0 ? 11 : month - 1;
                const monthLength = this._getMonthLength(lastMonth, year);
                if (month === 1) {
                    return new Date(year - 1, lastMonth, monthLength - offset);
                }
                return new Date(year, lastMonth, monthLength - offset);
            },

            _getOutsideClass (date, month) {
                return date.getMonth() === month ? '' : 'outside';
            }
        });
    </script>
</dom-module>
