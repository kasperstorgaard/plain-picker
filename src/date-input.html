<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-input/iron-input.html">
<link rel="import" href="./date-input-validator.html">
<link rel="import" href="./date-input-guesser.html">

<!--

    @demo demo/date-input.html 
-->

<dom-module id="date-input">
    <template>
        <style>
            :host {
                display: inline-block;
            }

            #date {
                width: 75px;
                padding: 3px 5px;
            }
            
            .error {
                margin-right:5px;
                background: orangered;
                border-radius: 3px;
                padding: 2px 3px;
                margin: 2px 3px;
                font-size: 10px;
                font-style: italic;
                color: white;
            }
        </style>
        <date-input-validator validator-name="date" errors="{{errors}}">
        </date-input-validator>
        <input is="iron-input" 
               id="date" 
               bind-value="{{_dateStr}}"
               prevent-invalid-input
               allowed-pattern="[0-9-]"
               maxlength="10"
               validator="date"
               placeholder$="[[format]]"
               on-input="_onInput"
               on-paste="_onPaste"
        />
        <date-input-guesser id="guesser"
                            format="[[format]]">
        </date-input-guesser>
        <div>
            <template is="dom-repeat" items="{{errors}}">
                <span class="error">{{item}}</span>
            </template>
        </div>
    </template>

    <script>
        Polymer({
            is: 'date-input',
            properties: {
                _dateStr: String,
                value: {
                    type: String,
                    notify: true,
                    computed: '_computeDate(format, _dateStr)'
                },
                errors: {
                    type: Array,
                    value: () => [],
                    notify: true
                },
                format: {
                    type: String,
                    value: 'DD-MM-YYYY'
                }
            },

            _computeDate (format, dateStr) {
                const year = this._getYear(format, dateStr);
                const month = this._getMonth(format, dateStr);
                const day = this._getDay(format, dateStr);
                return new Date(year, month, day);
            },

            _onInput (e) {
                const dateStr = e.target.value;
                this._dateStr = this._autoInsertHyphen(dateStr, this._lastDateStr || '');
                this.$.date.validate(this._dateStr);
                this._lastDateStr = dateStr;
            },

            _onPaste (e) {
                e.preventDefault();
                const clipboardData = e.clipboardData || window.clipboardData;
                const pastedStr = clipboardData.getData('Text');
                this._dateStr = this.$.guesser.guess(pastedStr);
                this.$.date.validate(this._dateStr);
            },

            _autoInsertHyphen (dateStr, lastDateStr) {
                const len = dateStr.length;
                // in case we deleted/edited marked text, return
                if (len <= lastDateStr.length) {
                    return dateStr;
                }
                const lastChar = dateStr[len - 1];
                if (lastChar !== '-' && (len === 2 || len === 5)) {
                    return `${this._dateStr}-`;
                }
                return dateStr;
            },

            _getFormatSubstr (formatChar, format, dateStr) {
                const from = format.indexOf(formatChar);
                const to = format.lastIndexOf(formatChar);
                return dateStr.slice(from, to + 1);
            },

            _getDay (format, dateStr) {
                const dayStr = this._getFormatSubstr('D', format, dateStr);
                return parseInt(dayStr, 10);
            },

            _getMonth (format, dateStr) {
                const monthStr = this._getFormatSubstr('M', format, dateStr);
                const monthNumber = parseInt(monthStr, 10);
                return isNaN(monthNumber) ? monthNumber : monthNumber - 1;
            },

            _getYear (format, dateStr) {
                const yearStr = this._getFormatSubstr('Y', format, dateStr);
                return parseInt(yearStr, 10);
            }
        });
    </script>
</dom-module>
