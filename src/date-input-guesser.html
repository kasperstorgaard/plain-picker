<link rel="import" href="../../polymer/polymer.html">

<dom-module id="date-input-guesser">
    <script>
        Polymer({
            is: 'date-input-guesser',
            properties: {
                format: {
                    type: String,
                    value: 'DD-MM-YYYY'
                }
            },

            guess (dateStr) {
                let str = dateStr;
                str = this._fixExtras(str);
                str = this._fixMonths(str);
                str = this._addSingleDigitStartPadding(str);
                str = this._addSingleDigitMidPadding(str);
                str = this._addYearPadding(str);
                return str;
            },

            _fixMonths (dateStr) {
                let str = dateStr;
                // replace month synonyms
                const monthMap = {
                    january: 1, jan: 1,
                    feburary: 2, feb: 2,
                    march: 3, mar: 3,
                    april: 4, apr: 4,
                    may: 5,
                    june: 6, jun: 6,
                    july: 7, jul: 7,
                    august: 8, aug: 8,
                    september: 9, sep: 9,
                    october: 10, oct: 10,
                    november: 11, nov: 11,
                    december: 12, dec: 12
                };

                const keys = Object.keys(monthMap);
                keys.forEach(key => {
                    str = str.replace(key, monthMap[key]);
                });

                return str;
            },

            _fixExtras (dateStr) {
                let str = dateStr;
                // generic extras
                const blackList = /([\.])|(\sof)/gi;
                str = str.replace(blackList, '');

                // delimiters
                str = str.replace(/[\/:\s]/g, '-');

                // day extras
                str = str.replace(/(st)|(nd)|(rd)|(th)/g, '');

                return str;
            },

            _addSingleDigitStartPadding (dateStr) {
                // start of string
                const singleStart = /^\d-/;
                return singleStart.test(dateStr) ? `0${dateStr}` : dateStr;
            },

            _addSingleDigitMidPadding (dateStr) {
                const singleMid = /\-(\d)\D/;
                const midMatch = singleMid.exec(dateStr);
                if (midMatch) {
                    const target = midMatch[0].length - 2;
                    const before = midMatch[0].slice(0, target);
                    const after = midMatch[0].slice(target);
                    return dateStr.replace(singleMid, `${before}0${after}`);
                }
                return dateStr;
            },

            _addYearPadding (dateStr) {
                const doubleYear = /-(\d\d)$/;
                const doubleMatch = doubleYear.exec(dateStr); // -10
                const year = parseInt(doubleMatch && doubleMatch[1], 10);
                if (!isNaN(year)) {
                    const centPrefix = year < 30 ? 20 : 19;
                    return dateStr.replace(doubleYear, `-${centPrefix}${year}`);
                }
                return dateStr;
            }
        });
    </script>
</dom-module>
