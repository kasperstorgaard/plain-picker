<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-validator-behavior/iron-validator-behavior.html">

<dom-module id="">
    <script>
        Polymer({
            is: 'date-input-validator',

            behaviors: [Polymer.IronValidatorBehavior],

            properties: {
                errors: {
                    type: Array,
                    value: () => [],
                    notify: true
                },
                format: {
                    type: String,
                    value: 'DD-MM-YYYY'
                }
            },

            validate (str) {
                if (typeof str !== 'string') {
                    throw new Error('date-input-validator must be given a string');
                }
                this._resetErrors();
                return this._checkLength(str) && this._checkDelimiters(str) &&
                    this._checkFormat(str, this.format);
            },

            _resetErrors () {
                if (!this.errors.length) {
                    return;
                }
                this.set('errors', []);
            },

            _checkLength (str) {
                if (str.length !== 10) {
                    this.push('errors', 'must be 10 characters long');
                    return false;
                }
                return true;
            },

            _checkDelimiters (str) {
                const re = /-/g;
                let delimiterCount = 0;
                while (re.exec(str)) { delimiterCount++; }
                if (delimiterCount !== 2) {
                    this.push('errors', 'must contain 2 \'-\' characters');
                    return false;
                }
                return true;
            },

            _checkFormat (str, format) {
                return this._checkDay(str, format) && this._checkMonth(str, format) &&
                    this._checkYear(str, format);
            },

            _checkDay (str, format) {
                const dayIndex = format.indexOf('DD');
                const day = parseInt(str.substr(dayIndex, 2), 10);
                if (isNaN(day) || day > 31 || day < 1) {
                    this.push('errors', 'invalid day format');
                    return false;
                }
                return true;
            },

            _checkMonth (str, format) {
                const monthIndex = format.indexOf('MM');
                const month = parseInt(str.substr(monthIndex, 2), 10);
                if (isNaN(month) || month > 12 || month < 1) {
                    this.push('errors', 'invalid month format');
                    return false;
                }
                return true;
            },

            _checkYear (str, format) {
                const yearIndex = format.indexOf('YYYY');
                const year = parseInt(str.substr(yearIndex, 4), 10);
                if (isNaN(year) || year < 0) {
                    this.push('errors', 'invalid year format');
                    return false;
                }
                return true;
            }
        });
    </script>
</dom-module>
